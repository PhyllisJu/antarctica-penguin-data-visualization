<!DOCTYPE html>
<html>
  <head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
  </head>

  <body>
    <h3>Palmer Archipelago (Antarctica) Penguin Data Visualization</h3>
    <svg id="geographic" height="600" width="1000"></svg>
    <svg id="culmen" height="600" width="1000"></svg>

    <script>
      const margins = { top: 50, right: 200, bottom: 75, left: 75 };
      d3.csv("dataset/penguins_size.csv", d3.autoType).then((data) => {
        console.log(data);

        //preprocess data
        indices = [];
        data.forEach(function (d, i) {
          if (
            d["culmen_length_mm"] == "NA" ||
            d["culmen_depth_mm"] == "NA" ||
            (!(d["sex"] == "MALE") && !(d["sex"] == "FEMALE"))
          ) {
            indices.push(i);
          }
          d["culmen_length_mm"] = Number(d["culmen_length_mm"]);
          d["culmen_depth_mm"] = Number(d["culmen_depth_mm"]);
        });
        for (i = indices.length - 1; i >= 0; i--) {
          data.splice(indices[i], 1);
        }
        console.log(data);

        // Geographic graph:
        const svg2 = d3.select("svg#geographic");
        const width2 = svg2.attr("width");
        const height2 = svg2.attr("height");
        const chartWidth2 = width2 - margins.left - margins.right;
        const chartHeight2 = height2 - margins.top - margins.bottom;
        // create extents
        const speciesExtent = ["Adelie", "Chinstrap", "Gentoo"]; // all species in the dataset
        const islandExtent = ["Torgersen", "Dream", "Biscoe"]; // all islands in the dataset
        let counts = {}; // a dictionary; stores the number of each species on each island
        islandExtent.forEach((island) => {
          counts[island] = {};
          speciesExtent.forEach((s) => {
            let filteredSpecies = data.filter(
              (d) => d["island"] === island && d["species"] === s
            );
            counts[island][s] = filteredSpecies.length;
          });
        });
        console.log(counts);
        const maxCount = d3.max(islandExtent, (island) =>
          d3.max(speciesExtent, (s) => counts[island][s])
        ); // y maximum
        // create scales
        const islandScale = d3
          .scaleBand()
          .domain(islandExtent)
          .range([0, chartWidth2])
          .padding(0.2);
        const speciesScale = d3
          .scaleBand()
          .domain(speciesExtent)
          .range([0, islandScale.bandwidth()])
          .padding(0.1);
        const countScale = d3
          .scaleLinear()
          .domain([0, maxCount])
          .range([chartHeight2, 0]);
        const colorScale2 = d3
          .scaleOrdinal()
          .domain(speciesExtent)
          .range(d3.schemeCategory10);
        // create axes
        let leftAxis2 = d3.axisLeft(countScale);
        svg2
          .append("g")
          .attr("transform", `translate(${margins.left - 10},${margins.top})`)
          .call(leftAxis2);
        let bottomAxis2 = d3.axisBottom(islandScale);
        svg2
          .append("g")
          .attr(
            "transform",
            `translate(${margins.left},${chartHeight2 + margins.top})`
          )
          .call(bottomAxis2);
        // creat labels
        svg2
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("x", -margins.top - chartHeight2 / 2)
          .attr("y", 25)
          .style("text-anchor", "middle")
          .style("font", "14px Courier")
          .text("Number of Penguins");
        svg2
          .append("text")
          .attr("x", margins.left + chartWidth2 / 2)
          .attr("y", margins.top + chartHeight2 + 50)
          .style("text-anchor", "middle")
          .style("font", "14px Courier")
          .text("Island");
        // create chart area
        const chartArea2 = svg2
          .append("g")
          .attr("transform", `translate(${margins.left}, ${margins.top})`);
        // draw the bar groups for each island
        const islandGroups = chartArea2
          .selectAll(".island-group")
          .data(islandExtent)
          .enter()
          .append("g")
          .attr("class", "island-group");
        islandGroups.each(function (island) {
          let barGroup = d3.select(this);
          barGroup
            .selectAll("rect")
            .data(speciesExtent)
            .join("rect")
            .attr("x", (s) => islandScale(island) + speciesScale(s))
            .attr("y", (s) => countScale(counts[island][s]))
            .attr("width", speciesScale.bandwidth())
            .attr("height", (s) => chartHeight2 - countScale(counts[island][s]))
            .attr("fill", (s) => colorScale2(s));
          // add labels
          barGroup
            .selectAll("text")
            .data(speciesExtent)
            .join("text")
            .attr(
              "x",
              (s) =>
                islandScale(island) +
                speciesScale(s) +
                speciesScale.bandwidth() / 2
            )
            .attr("y", (s) => countScale(counts[island][s]) - 5)
            .attr("text-anchor", "middle")
            .text((s) => counts[island][s])
            .style("fill", (s) => colorScale2(s));
        });
        // draw the legend
        const legend2 = chartArea2
          .append("g")
          .attr("transform", `translate(${chartWidth2}, 0)`);
        speciesExtent.forEach((s, i) => {
          legend2
            .append("rect")
            .attr("x", 0)
            .attr("y", i * 30)
            .attr("width", 18)
            .attr("height", 18)
            .attr("fill", colorScale2(s));

          legend2
            .append("text")
            .attr("x", 25)
            .attr("y", i * 30 + 9)
            .text(s)
            .attr("text-anchor", "start")
            .style("alignment-baseline", "middle");
        });

        // Culmen graph:
        //create axes and gridlines
        let svg = d3.select("svg#culmen");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const chartWidth = width - margins.left - margins.right;
        const chartHeight = height - margins.top - margins.bottom;
        const lengthExtent = d3.extent(data, (d) => d["culmen_length_mm"]);
        const xScale = d3
          .scaleLinear()
          .domain(lengthExtent)
          .range([0, chartWidth]);
        const depthExtent = d3.extent(data, (d) => d["culmen_depth_mm"]);
        const yScale = d3
          .scaleLinear()
          .domain(depthExtent)
          .range([chartHeight, 0]);
        function colorScale(sp, g) {
          let hue = 0;
          if (g == "MALE") {
            hue += 180;
          }
          if (sp == "Chinstrap") {
            hue += 60;
          }
          if (sp == "Gentoo") {
            hue += 120;
          }
          return d3.hsl(hue, 1, 0.4);
        }
        let bottomAxis = d3.axisBottom(xScale).ticks(5);
        let verticalGridlines = d3
          .axisBottom(xScale)
          .ticks(5)
          .tickSize(-chartHeight - 10)
          .tickFormat("");
        svg
          .append("g")
          .attr("class", "x axis")
          .attr(
            "transform",
            `translate(${margins.left},${chartHeight + margins.top + 10})`
          )
          .call(bottomAxis);
        svg
          .append("g")
          .attr("class", "vgridlines")
          .attr(
            "transform",
            `translate(${margins.left},${chartHeight + margins.top + 10})`
          )
          .call(verticalGridlines);
        let leftAxis = d3.axisLeft(yScale).ticks(5);
        let horizontalGridlines = d3
          .axisLeft(yScale)
          .ticks(5)
          .tickSize(-chartWidth - 10)
          .tickFormat("");
        svg
          .append("g")
          .attr("class", "y axis")
          .attr("transform", `translate(${margins.left - 10},${margins.top})`)
          .call(leftAxis);
        svg
          .append("g")
          .attr("class", "hgridlines")
          .attr("transform", `translate(${margins.left - 10},${margins.top})`)
          .call(horizontalGridlines);
        let chartArea = svg
          .append("g")
          .attr("transform", `translate(${margins.left},${margins.top})`);
        //plot data points as circles
        chartArea
          .selectAll("circle")
          .data(data)
          .join("circle")
          .attr("fill", (d) => colorScale(d["species"], d["sex"]))
          .attr("cx", (d) => xScale(d["culmen_length_mm"]))
          .attr("cy", (d) => yScale(d["culmen_depth_mm"]))
          .attr("r", 5)
          .attr("opacity", 0.8);

        //add legend
        let legend = svg
          .append("g")
          .attr(
            "transform",
            "translate(" +
              (Number(chartWidth) + Number(margins.left) + 10) +
              "," +
              Number(margins.top) +
              ")"
          );
        let categories = [
          ["Adelie", "MALE"],
          ["Adelie", "FEMALE"],
          ["Chinstrap", "MALE"],
          ["Chinstrap", "FEMALE"],
          ["Gentoo", "MALE"],
          ["Gentoo", "FEMALE"],
        ];
        legend
          .selectAll(".legend")
          .data(categories)
          .join("g")
          .attr("class", "legend")
          .attr("transform", function (d, i) {
            return "translate(0," + i * 30 + ")";
          })
          .append("rect")
          .attr("x", 0)
          .attr("width", 18)
          .attr("height", 18)
          .style("fill", function (d) {
            return colorScale(d[0], d[1]);
          });
        legend
          .selectAll(".legend")
          .append("text")
          .attr("x", 25)
          .attr("y", 14)
          .style("text-anchor", "start")
          .text(function (d) {
            return d[0] + " - " + d[1].toLowerCase();
          });

        //add title
        let title = svg
          .append("text")
          .attr("x", margins.left + chartWidth / 2)
          .attr("y", 25)
          .style("text-anchor", "middle")
          .style("font", "14px Courier")
          .text(
            "Culmen Length(mm) and Width(mm) of Male and Female Adelie, Chinstrap, and Gentoo Penguins"
          );

        let ylabel = svg
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr("x", -margins.top - chartHeight / 2)
          .attr("y", 25)
          .style("text-anchor", "middle")
          .style("font", "14px Courier")
          .text("Culmen Depth(mm)");

        let xlabel = svg
          .append("text")
          .attr("x", margins.left + chartWidth / 2)
          .attr("y", margins.top + chartHeight + 50)
          .style("text-anchor", "middle")
          .style("font", "14px Courier")
          .text("Culmen Length(mm)");
      });
    </script>
  </body>
</html>
